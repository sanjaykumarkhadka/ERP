{% extends 'index.html' %}

{% block content %}
<div style="width: 100%">
    <!-- Packing Search Section -->
    <section id="search">
        <h2>Packing Search</h2>
        <form id="searchForm">
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="product_code_search">Product Code:</label>
                        <input type="text" class="form-control" id="product_code_search" placeholder="Search by product code">
                        <input type="hidden" id="search_fg_code" name="fg_code" value="{{ search_fg_code | default('') }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="search_description">Description:</label>
                        <input type="text" id="search_description" name="description" value="{{ search_description | default('') }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="search_packing_date_start">Packing Date (From):</label>
                        <input type="date" id="search_packing_date_start" name="packing_date_start" value="{{ search_packing_date_start | default('') }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="search_packing_date_end">Packing Date (To):</label>
                        <input type="date" id="search_packing_date_end" name="packing_date_end" value="{{ search_packing_date_end | default('') }}">
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="search_week_commencing">Week Commencing:</label>
                        <input type="date" id="search_week_commencing" name="week_commencing" value="{{ search_week_commencing | default('') }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="search_machinery">Machinery:</label>
                        <select id="search_machinery" name="machinery">
                            <option value="">All Machinery</option>
                            <!-- Options will be populated dynamically via JavaScript -->
                        </select>
                    </div>
                </div>
            </div>
            <button type="button" onclick="fetchPackings()">Search</button>
            <button type="button" class="btn btn-primary" onclick="exportToExcel()">Export to Excel</button>
            <div id="fg_code_suggestions" class="suggestion-list"></div>
        </form>
    </section>

    <!-- Column Visibility Toggle Section -->
    <section id="column-toggle">
        <h3>Column Visibility</h3>
        <div class="column-toggle">
            <div class="toggle-row">
                <label><input type="checkbox" checked data-col-index="2" onchange="toggleColumn(2)"> Week Commencing</label>
                <label><input type="checkbox" checked data-col-index="3" onchange="toggleColumn(3)"> Packing Date</label>
                <label><input type="checkbox" checked data-col-index="6" onchange="toggleColumn(6)"> Special Order KG</label>
                <label><input type="checkbox" checked data-col-index="7" onchange="toggleColumn(7)"> Special Order Unit</label>
                <label><input type="checkbox" checked data-col-index="10" onchange="toggleColumn(10)"> Avg Weight per Unit</label>
            </div>
            <div class="toggle-row">
                <label><input type="checkbox" data-col-index="11" onchange="toggleColumn(11)"> SOH Req KG/Week</label>
                <label><input type="checkbox" checked data-col-index="12" onchange="toggleColumn(12)"> SOH Req Units/Week</label>
                <label><input type="checkbox" data-col-index="13" onchange="toggleColumn(13)"> SOH KG</label>
                <label><input type="checkbox" data-col-index="14" onchange="toggleColumn(14)"> SOH Units</label>
                <label><input type="checkbox" checked data-col-index="15" onchange="toggleColumn(15)"> Machinery</label>
            </div>
            <div class="toggle-row">
                <label><input type="checkbox" data-col-index="16" onchange="toggleColumn(16)"> Total Stock KG</label>
                <label><input type="checkbox" data-col-index="17" onchange="toggleColumn(17)"> Total Stock Units</label>
                <label><input type="checkbox" checked data-col-index="18" onchange="toggleColumn(18)"> Calculation Factor</label>
                <label><input type="checkbox" checked data-col-index="19" onchange="toggleColumn(19)"> Priority</label>
            </div>
            <div class="toggle-actions">
                <button type="button" class="btn btn-sm btn-secondary" onclick="showEssentialColumns()">Show Essential Only</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="showAllColumns()">Show All</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="resetToDefault()">Reset to Default</button>
            </div>
        </div>
    </section>

    <!-- Packing List Section -->
    <section id="list">
        <h2>Packing List</h2>
        <a href="{{ url_for('packing.packing_create') }}" class="btn btn-primary my-3">Create New Packing</a>
        <a href="#" class="btn btn-primary my-3" data-bs-toggle="modal" data-bs-target="#bulkEditModal">Bulk Edit</a>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <div id="resultSection" class="table-container">
            <table class="table table-bordered" id="packingListTable">
                <thead>
                    <tr>
                        <th data-col-index="1"><input type="checkbox" id="selectAll"></th>
                        <th data-column="week_commencing" data-col-index="2">Week Commencing <span class="sort-arrow"></span></th>
                        <th data-column="packing_date" data-col-index="3">Packing Date <span class="sort-arrow"></span></th>
                        <th data-column="item_code" data-col-index="4">Product Code <span class="sort-arrow"></span></th>
                        <th data-column="description" data-col-index="5">Product Description <span class="sort-arrow"></span></th>
                        <th data-column="special_order_kg" data-col-index="6">Special Order KG <span class="sort-arrow"></span></th>
                        <th data-column="special_order_unit" data-col-index="7">Special Order Unit <span class="sort-arrow"></span></th>
                        <th data-column="requirement_kg" data-col-index="8">Requirement KG <span class="sort-arrow"></span></th>
                        <th data-column="requirement_unit" data-col-index="9">Requirement Unit <span class="sort-arrow"></span></th>
                        <th data-column="avg_weight_per_unit" data-col-index="10">AVG Weight per Unit <span class="sort-arrow"></span></th>
                        <th data-col-index="11">SOH Req KG/Week</th>
                        <th data-column="soh_requirement_units_week" data-col-index="12">SOH Req Units/Week <span class="sort-arrow"></span></th>
                        <th data-col-index="13">SOH KG</th>
                        <th data-col-index="14">SOH Units</th>
                        <th data-column="machinery" data-col-index="15">Machinery <span class="sort-arrow"></span></th>
                        <th data-col-index="16">Total Stock KG</th>
                        <th data-col-index="17">Total Stock Units</th>
                        <th data-column="calculation_factor" data-col-index="18">Calculation Factor <span class="sort-arrow"></span></th>
                        <th data-column="priority" data-col-index="19">Priority <span class="sort-arrow"></span></th>
                        <th data-col-index="20">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in packing_data %}
                    <tr>
                        <td><input type="checkbox" class="packing-select" value="{{ data.packing.id }}"></td>
                        <td>{{ data.week_commencing }}</td>
                        <td>{{ data.packing.packing_date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ data.packing.item.item_code }}</td>
                        <td>{{ data.packing.item.description }}</td>
                        <td data-field="special_order_kg" data-id="{{ data.packing.id }}" class="editable-cell" ondblclick="makeEditable(this)">{{ data.packing.special_order_kg }}</td>
                        <td data-field="special_order_unit">{{ data.special_order_unit }}</td>
                        <td data-field="requirement_kg">{{ data.requirement_kg }}</td>
                        <td data-field="requirement_unit">{{ data.requirement_unit }}</td>
                        <td>{{ data.packing.item.avg_weight_per_unit }}</td>
                        <td data-field="soh_requirement_kg_week">{{ data.soh_requirement_kg_week }}</td>
                        <td data-field="soh_requirement_units_week">{{ data.packing.soh_requirement_units_week }}</td>
                        <td data-field="soh_kg">{{ data.soh_kg }}</td>
                        <td data-field="soh_units">{{ data.soh_units }}</td>
                        <td>
                            <select name="machinery" data-id="{{ data.packing.id }}" data-field="machinery" onchange="updateCellSelect(this)" class="form-control form-control-sm">
                                <option value="">Select Machinery</option>
                                {% for machine in machinery_list %}
                                <option value="{{ machine.machineID }}" {% if data.packing.machinery_id == machine.machineID %}selected{% endif %}>{{ machine.machineryName }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td data-field="total_stock_kg">{{ data.total_stock_kg }}</td>
                        <td data-field="total_stock_units">{{ data.total_stock_units }}</td>
                        <td data-field="calculation_factor">{{ data.packing.calculation_factor }}</td>
                        <td data-field="priority" data-id="{{ data.packing.id }}" class="editable-cell" ondblclick="makeEditable(this)">{{ data.packing.priority }}</td>
                        <td>
                            <a href="{{ url_for('packing.packing_edit', id=data.packing.id) }}" class="btn btn-sm btn-primary">Edit</a>
                            <form action="{{ url_for('packing.packing_delete', id=data.packing.id) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this packing?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="20" class="no-results">No packing records found.</td></tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td style="text-align: right; font-weight: bold; border-right: none;" colspan="7">Total:</td>
                        <td id="total_requirement_kg" style="font-weight: bold; text-align: right; border-left: none; white-space: nowrap;">{{ total_requirement_kg }}</td>
                        <td id="total_requirement_unit" style="font-weight: bold; text-align: right; white-space: nowrap;">{{ total_requirement_unit }}</td>
                        <td style="border: none;" colspan="11"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Bulk Edit Modal -->
        <div class="modal fade" id="bulkEditModal" tabindex="-1" aria-labelledby="bulkEditModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="bulkEditModalLabel">Bulk Edit Packing Entries</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="bulkEditForm">
                            <div class="mb-3">
                                <label for="bulk_special_order_kg" class="form-label">Special Order (KG)</label>
                                <input type="number" step="0.01" class="form-control" id="bulk_special_order_kg" name="special_order_kg">
                            </div>
                            <div class="mb-3">
                                <label for="bulk_calculation_factor" class="form-label">Calculation Factor</label>
                                <input type="number" step="0.01" class="form-control" id="bulk_calculation_factor" name="calculation_factor">
                            </div>
                            <div class="mb-3">
                                <label for="bulk_machinery" class="form-label">Machinery</label>
                                <select class="form-control" id="bulk_machinery" name="machinery">
                                    <option value="">Select Machinery</option>
                                    <!-- Machinery options will be populated dynamically via JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="bulk_priority" class="form-label">Priority</label>
                                <input type="number" class="form-control" id="bulk_priority" name="priority">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitBulkEdit()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<style>
    .suggestion-list {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        max-height: 200px;
        overflow-y: auto;
        width: 100%;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .suggestion-list ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .suggestion-list li {
        padding: 8px 12px;
        cursor: pointer;
    }
    .suggestion-list li:hover {
        background-color: #f5f5f5;
    }
    .form-group {
        margin-bottom: 15px;
    }
    
    /* Column visibility styles */
    .column-toggle {
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .toggle-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 10px;
    }
    
    .toggle-row label {
        display: flex;
        align-items: center;
        font-size: 14px;
        white-space: nowrap;
    }
    
    .toggle-row input[type="checkbox"] {
        margin-right: 5px;
    }
    
    .toggle-actions {
        margin-top: 10px;
    }
    
    .toggle-actions button {
        margin-right: 10px;
    }
    
    /* Style for machinery filter dropdown */
    #search_machinery {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    
    /* Column Toggle Styles */
    #column-toggle {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid #dee2e6;
    }
    
    #column-toggle h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #495057;
        font-size: 1.1rem;
    }
    
    .column-toggle {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .toggle-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 5px;
    }
    
    .column-toggle label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 0.9rem;
        min-width: 180px;
        padding: 2px 0;
    }
    
    .column-toggle input[type="checkbox"] {
        margin-right: 6px;
        transform: scale(1.1);
    }
    
    .toggle-actions {
        margin-top: 10px;
        display: flex;
        gap: 8px;
    }
    
    .toggle-actions button {
        font-size: 0.85rem;
        padding: 4px 8px;
    }
    
    /* Table Styles */
    .table-container {
        overflow-x: auto;
        margin-top: 20px;
    }
    
    .table th {
        white-space: nowrap;
        background-color: #f8f9fa;
        position: relative;
        cursor: pointer;
    }
    
    .sort-arrow {
        display: inline-block;
        width: 0;
        height: 0;
        margin-left: 5px;
        vertical-align: middle;
    }
    
    .sort-arrow.asc {
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-bottom: 4px solid #333;
    }
    
    .sort-arrow.desc {
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-top: 4px solid #333;
    }
    
    .table td {
        white-space: nowrap;
    }
    
    .no-results {
        text-align: center;
        font-style: italic;
        color: #666;
    }
    
    /* Inline editing styles */
    .editable-cell {
        cursor: pointer;
        position: relative;
    }
    
    .editable-cell:hover {
        background-color: #f8f9fa;
        outline: 1px solid #dee2e6;
    }
    
    .editable-cell.editing {
        padding: 0;
    }
    
    .editable-cell input {
        width: 100%;
        border: none;
        padding: 8px;
        margin: 0;
        background: #fff;
        border: 2px solid #007bff;
        border-radius: 3px;
        outline: none;
    }
    
    .editable-cell.editing::after {
        content: "Press Enter to save, Esc to cancel";
        position: absolute;
        bottom: -20px;
        left: 0;
        font-size: 11px;
        color: #666;
        white-space: nowrap;
        z-index: 1000;
        background: white;
        padding: 2px 5px;
        border: 1px solid #ddd;
        border-radius: 3px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
</style>

<script>
    // Global machinery options for dynamic select building
    let machineryOptions = [];
    
    // Initialize machinery filter options
    console.log('Fetching machinery options...');
    fetch('/packing/machinery_options')
        .then(response => {
            console.log('Machinery options response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Machinery options data:', data);
            machineryOptions = data; // Store globally for dynamic select building
            populateMachineryDropdowns(data);
        })
        .catch(error => {
            console.error('Error loading machinery options via AJAX:', error);
            // Fallback: Extract machinery options from existing server-rendered dropdowns
            const existingOptions = extractMachineryOptionsFromPage();
            if (existingOptions.length > 0) {
                console.log('Using server-rendered machinery options as fallback');
                machineryOptions = existingOptions;
                populateMachineryDropdowns(existingOptions);
            } else {
                console.error('No machinery options available (neither AJAX nor server-rendered)');
            }
        });

    // Function to populate machinery dropdowns
    function populateMachineryDropdowns(data) {
        const select = document.getElementById('search_machinery');
        const bulkSelect = document.getElementById('bulk_machinery');
        
        if (select && data && Array.isArray(data)) {
            // Clear existing options except the first "All Machinery" option
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            data.forEach(machinery => {
                const option = new Option(machinery.machineryName, machinery.machineID);
                select.add(option);
            });
            console.log(`Added ${data.length} machinery options to search dropdown`);
        }
        
        if (bulkSelect && data && Array.isArray(data)) {
            // Clear existing options except the first "Select Machinery" option
            while (bulkSelect.children.length > 1) {
                bulkSelect.removeChild(bulkSelect.lastChild);
            }
            
            data.forEach(machinery => {
                const option = new Option(machinery.machineryName, machinery.machineID);
                bulkSelect.add(option);
            });
            console.log(`Added ${data.length} machinery options to bulk edit dropdown`);
        }
    }

    // Function to extract machinery options from server-rendered dropdowns
    function extractMachineryOptionsFromPage() {
        const options = [];
        // Look for existing machinery selects in the table
        const existingSelect = document.querySelector('select[name="machinery"]');
        if (existingSelect) {
            const machineOptions = existingSelect.querySelectorAll('option[value]:not([value=""])');
            machineOptions.forEach(option => {
                if (option.value) {
                    options.push({
                        machineID: parseInt(option.value),
                        machineryName: option.textContent.trim()
                    });
                }
            });
        }
        return options;
    }

    // Helper function to build machinery select options
    function buildMachinerySelect(packingId, currentMachineryId) {
        let optionsHtml = '<option value="">Select Machinery</option>';
        machineryOptions.forEach(machine => {
            const selected = (currentMachineryId == machine.machineID) ? 'selected' : '';
            optionsHtml += `<option value="${machine.machineID}" ${selected}>${machine.machineryName}</option>`;
        });
        return `<select name="machinery" data-id="${packingId}" data-field="machinery" onchange="updateCellSelect(this)" class="form-control form-control-sm">${optionsHtml}</select>`;
    }



    // jQuery UI Autocomplete for product code search
    $(document).ready(function() {
    // Wait a bit for all libraries to load
    setTimeout(function() {
        console.log("Initializing packing autocomplete...");
        console.log("jQuery version:", $.fn.jquery);
        console.log("jQuery UI loaded:", typeof $.ui !== 'undefined');
        console.log("Autocomplete available:", typeof $.ui.autocomplete !== 'undefined');
        
        // Ensure jQuery UI is loaded
        if (typeof $.ui === 'undefined' || typeof $.ui.autocomplete === 'undefined') {
            console.error("jQuery UI autocomplete not available");
            return;
        }
        
        // Initialize autocomplete for product code search
        $("#product_code_search").autocomplete({
            source: function(request, response) {
                console.log("Packing autocomplete request for:", request.term);
                
                $.ajax({
                    url: "/packing/search_product_codes",
                    type: "GET",
                    dataType: "json",
                    data: { term: request.term },
                    success: function(data) {
                        console.log("Packing autocomplete response:", data);
                        if (Array.isArray(data)) {
                            var suggestions = data.map(function(item) {
                                return {
                                    label: item.product_code + ' - ' + item.description,
                                    value: item.product_code
                                };
                            });
                            response(suggestions);
                        } else {
                            response([]);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Packing autocomplete error:", error, "Status:", xhr.status);
                        response([]);
                    }
                });
            },
            minLength: 2,
            delay: 300,
            select: function(event, ui) {
                console.log("Selected packing item:", ui.item);
                $(this).val(ui.item.value);
                $('#search_fg_code').val(ui.item.value);
                fetchPackings();
                return false;
            },
            focus: function(event, ui) {
                return false;
            }
        });

        // Also update the hidden field when typing
        $("#product_code_search").on('input', function() {
            $('#search_fg_code').val($(this).val());
        });
        
        console.log("Packing autocomplete initialized");
    }, 1000); // Close setTimeout
    });

    // Fetch packings with search parameters and sorting
    function fetchPackings() {
        const searchParams = new URLSearchParams({
            fg_code: document.getElementById('search_fg_code').value,
            description: document.getElementById('search_description').value,
            packing_date_start: document.getElementById('search_packing_date_start').value,
            packing_date_end: document.getElementById('search_packing_date_end').value,
            week_commencing: document.getElementById('search_week_commencing').value,
            machinery: document.getElementById('search_machinery').value,
            sort_by: currentSortColumn,
            sort_order: currentSortOrder
        });

        fetch(`/packing/search?${searchParams}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#packingListTable tbody');
                tbody.innerHTML = '';

                if (data.packings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="20" class="no-results">No packing records found.</td></tr>';
                    document.getElementById('total_requirement_kg').textContent = '0';
                    document.getElementById('total_requirement_unit').textContent = '0';
        return;
    }

            let totalRequirementKg = 0;
            let totalRequirementUnit = 0;

                data.packings.forEach(packing => {
                    // Build machinery select options dynamically
                    let machineryOptionsHtml = '<option value="">Select Machinery</option>';
                    machineryOptions.forEach(machine => {
                        const selected = (packing.machinery && packing.machinery.machineID == machine.machineID) ? 'selected' : '';
                        machineryOptionsHtml += `<option value="${machine.machineID}" ${selected}>${machine.machineryName}</option>`;
                    });

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" class="packing-select" value="${packing.id}"></td>
                        <td>${packing.week_commencing}</td>
                        <td>${packing.packing_date}</td>
                        <td>${packing.item.item_code}</td>
                        <td>${packing.item.description}</td>
                        <td data-field="special_order_kg" data-id="${packing.id}" class="editable-cell" ondblclick="makeEditable(this)">${packing.special_order_kg}</td>
                        <td data-field="special_order_unit">${packing.special_order_unit}</td>
                        <td data-field="requirement_kg">${packing.requirement_kg}</td>
                        <td data-field="requirement_unit">${packing.requirement_unit}</td>
                        <td>${packing.item.avg_weight_per_unit}</td>
                        <td data-field="soh_requirement_kg_week">${packing.soh_requirement_kg_week}</td>
                        <td data-field="soh_requirement_units_week">${packing.soh_requirement_units_week}</td>
                        <td data-field="soh_kg">${packing.soh_kg}</td>
                        <td data-field="soh_units">${packing.soh_units}</td>
                        <td>
                            <select name="machinery" data-id="${packing.id}" data-field="machinery" onchange="updateCellSelect(this)" class="form-control form-control-sm">
                                ${machineryOptionsHtml}
                            </select>
                        </td>
                        <td data-field="total_stock_kg">${packing.total_stock_kg}</td>
                        <td data-field="total_stock_units">${packing.total_stock_units}</td>
                        <td data-field="calculation_factor">${packing.calculation_factor}</td>
                        <td data-field="priority" data-id="${packing.id}" class="editable-cell" ondblclick="makeEditable(this)">${packing.priority}</td>
                        <td>
                            <a href="/packing/edit/${packing.id}" class="btn btn-sm btn-primary">Edit</a>
                            <form action="/packing/delete/${packing.id}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this packing?')">Delete</button>
                            </form>
                        </td>
                    `;
                    tbody.appendChild(row);

                    totalRequirementKg += parseFloat(packing.requirement_kg) || 0;
                    totalRequirementUnit += parseInt(packing.requirement_unit) || 0;
                });

                document.getElementById('total_requirement_kg').textContent = totalRequirementKg.toFixed(2);
                document.getElementById('total_requirement_unit').textContent = totalRequirementUnit;
                
                // Reapply column visibility after loading new data
                applyColumnVisibility();
            })
            .catch(error => console.error('Error:', error));
    }

    // Sorting functionality
    let currentSortColumn = '';
    let currentSortOrder = '';

    document.querySelectorAll('th[data-column]').forEach(th => {
        th.addEventListener('click', () => {
            const column = th.dataset.column;
            
            // Reset all arrows
            document.querySelectorAll('.sort-arrow').forEach(arrow => {
                arrow.textContent = '';
            });

            if (currentSortColumn === column) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
                currentSortColumn = column;
                currentSortOrder = 'asc';
            }

            // Update arrow
            th.querySelector('.sort-arrow').textContent = currentSortOrder === 'asc' ? ' ↑' : ' ↓';

            fetchPackings();
        });
    });

    // Column visibility functions
    function toggleColumn(colIndex) {
        const table = document.getElementById('packingListTable');
        const checkbox = document.querySelector(`input[data-col-index="${colIndex}"]`);
        
        if (!checkbox) {
            console.error(`No checkbox found for column ${colIndex}`);
            return;
        }
        
        const isVisible = checkbox.checked;
        const displayValue = isVisible ? '' : 'none';
        
        // Toggle header cells
        const headerCells = table.querySelectorAll(`th[data-col-index="${colIndex}"]`);
        headerCells.forEach(cell => {
            cell.style.display = displayValue;
        });
        
        // Toggle body cells
        const bodyCells = table.querySelectorAll(`tbody td:nth-child(${colIndex})`);
        bodyCells.forEach(cell => {
            cell.style.display = displayValue;
        });

        // Special handling for footer - don't toggle if it's the requirement columns
        if (colIndex !== 8 && colIndex !== 9) {
            const footerCells = table.querySelectorAll(`tfoot td:nth-child(${colIndex})`);
            footerCells.forEach(cell => {
                if (!cell.id || (!cell.id.includes('total_requirement_kg') && !cell.id.includes('total_requirement_unit'))) {
                    cell.style.display = displayValue;
                }
            });
        }

        // Update total row colspan if needed
        updateTotalRowSpan();
    }

    function updateTotalRowSpan() {
        const totalRow = document.querySelector('tfoot tr');
        if (totalRow) {
            // Count visible columns before Requirement KG
            const visibleColumns = Array.from(document.querySelectorAll('th[data-col-index]'))
                .filter(th => th.style.display !== 'none' && parseInt(th.dataset.colIndex) < 8)
                .length;
            
            // Update colspan of total cell
            const totalCell = totalRow.cells[0];
            totalCell.setAttribute('colspan', visibleColumns);
        }
    }

    function showAllColumns() {
        document.querySelectorAll('.column-toggle input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
            const colIndex = parseInt(checkbox.getAttribute('data-col-index'));
            toggleColumn(colIndex);
        });

        // Reset total row display
        const totalRow = document.querySelector('tfoot tr');
        if (totalRow) {
            Array.from(totalRow.cells).forEach(cell => {
                cell.style.display = '';
            });
            updateTotalRowSpan();
        }
    }

    function showEssentialColumns() {
        // Essential columns: Checkbox, Product Code, Description, Requirement KG, Requirement Unit, Machinery, Actions
        const essentialColumns = [1, 4, 5, 8, 9, 15, 20];
        
        // Update checkboxes and toggle columns
        document.querySelectorAll('.column-toggle input[type="checkbox"]').forEach(checkbox => {
            const colIndex = parseInt(checkbox.getAttribute('data-col-index'));
            const isEssential = essentialColumns.includes(colIndex);
            checkbox.checked = isEssential;
            toggleColumn(colIndex);
        });

        // Update total row
        const totalRow = document.querySelector('tfoot tr');
        if (totalRow) {
            // Reset all cells display
            Array.from(totalRow.cells).forEach(cell => {
                cell.style.display = '';
            });

            // Calculate visible columns before Requirement KG
            const visibleBeforeReq = essentialColumns.filter(col => col < 8).length;
            
            // Set colspan for the "Total:" cell
            const totalCell = totalRow.cells[0];
            totalCell.setAttribute('colspan', visibleBeforeReq);
            
            // Make sure total cells are visible and properly positioned
            const reqKgCell = totalRow.querySelector('#total_requirement_kg');
            const reqUnitCell = totalRow.querySelector('#total_requirement_unit');
            if (reqKgCell) {
                reqKgCell.style.display = '';
                reqKgCell.style.position = 'sticky';
            }
            if (reqUnitCell) {
                reqUnitCell.style.display = '';
                reqUnitCell.style.position = 'sticky';
            }
        }
    }

    function resetToDefault() {
        const defaultColumns = [2, 3, 6, 7, 10, 12, 15, 18, 19]; // Your default visible columns
        document.querySelectorAll('.column-toggle input[type="checkbox"]').forEach(checkbox => {
            const colIndex = parseInt(checkbox.getAttribute('data-col-index'));
            checkbox.checked = defaultColumns.includes(colIndex);
            toggleColumn(colIndex);
        });
    }

    // Initialize column visibility
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initializing column visibility on page load');
        applyColumnVisibility();
    });

    // Bulk edit functionality
function submitBulkEdit() {
        const selectedIds = Array.from(document.querySelectorAll('.packing-select:checked')).map(cb => cb.value);
    if (selectedIds.length === 0) {
            alert('Please select at least one packing entry to edit.');
        return;
    }

        const data = {
            packing_ids: selectedIds,
            updates: {
                special_order_kg: document.getElementById('bulk_special_order_kg').value || null,
                calculation_factor: document.getElementById('bulk_calculation_factor').value || null,
                machinery: document.getElementById('bulk_machinery').value || null,
                priority: document.getElementById('bulk_priority').value || null
            }
        };

        fetch('/packing/bulk_edit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating entries');
        });
    }

    // Select all functionality
    document.getElementById('selectAll').addEventListener('change', function() {
        document.querySelectorAll('.packing-select').forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    // Export to Excel functionality
    function exportToExcel() {
        const searchParams = new URLSearchParams({
            fg_code: document.getElementById('search_fg_code').value,
            description: document.getElementById('search_description').value,
            packing_date_start: document.getElementById('search_packing_date_start').value,
            packing_date_end: document.getElementById('search_packing_date_end').value,
            week_commencing: document.getElementById('search_week_commencing').value,
            machinery: document.getElementById('search_machinery').value
        });

        window.location.href = `/packing/export?${searchParams}`;
    }

    // Inline editing functionality
    function makeEditable(cell) {
        // Prevent multiple edits
        if (cell.classList.contains('editing')) {
            return;
        }
        
        const currentValue = cell.textContent.trim();
        const field = cell.dataset.field;
        const packingId = cell.dataset.id;
        
        // Create input element
        const input = document.createElement('input');
        input.type = field === 'priority' ? 'number' : 'number';
        input.step = field === 'special_order_kg' ? '0.01' : '1';
        input.value = currentValue;
        input.min = '0';
        
        // Set cell to editing mode
        cell.classList.add('editing');
        cell.innerHTML = '';
        cell.appendChild(input);
        
        // Focus and select the input
        input.focus();
        input.select();
        
        // Handle save and cancel
        function saveEdit() {
            const newValue = input.value;
            updateCellValue(packingId, field, newValue, cell, currentValue);
        }
        
        function cancelEdit() {
            cell.classList.remove('editing');
            cell.textContent = currentValue;
        }
        
        // Event listeners
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveEdit();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelEdit();
            }
        });
        
        input.addEventListener('blur', function() {
            saveEdit();
        });
    }
    
    function updateCellValue(packingId, field, value, cell, originalValue) {
        fetch('/packing/update_cell', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: packingId,
                field: field,
                value: value
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update the cell
                cell.classList.remove('editing');
                cell.textContent = value;
                
                // Show success feedback
                cell.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    cell.style.backgroundColor = '';
                }, 1000);
                
                // Update other calculated fields in the same row
                if (data.updates) {
                    const row = cell.closest('tr');
                    for (const [key, val] of Object.entries(data.updates)) {
                        const targetCell = row.querySelector(`td[data-field="${key}"]`);
                        if (targetCell && targetCell !== cell) {
                            targetCell.textContent = val;
                        }
                    }
                    
                    // Update totals if requirement_kg changed
                    if (data.updates.requirement_kg !== undefined || data.updates.requirement_unit !== undefined) {
                        updateTotals();
                    }
                }
            } else {
                console.error('Update failed:', data.error);
                alert('Error updating: ' + (data.error || 'Unknown error'));
                cell.classList.remove('editing');
                cell.textContent = originalValue;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating: ' + error.message);
            cell.classList.remove('editing');
            cell.textContent = originalValue;
        });
    }
    
    function updateTotals() {
        let totalRequirementKg = 0;
        let totalRequirementUnit = 0;
        
        // Sum all requirement values
        document.querySelectorAll('td[data-field="requirement_kg"]').forEach(cell => {
            totalRequirementKg += parseFloat(cell.textContent) || 0;
        });
        
        document.querySelectorAll('td[data-field="requirement_unit"]').forEach(cell => {
            totalRequirementUnit += parseInt(cell.textContent) || 0;
        });
        
        // Update totals in footer
        document.getElementById('total_requirement_kg').textContent = totalRequirementKg.toFixed(2);
        document.getElementById('total_requirement_unit').textContent = totalRequirementUnit;
    }

    // Update cell function for machinery select dropdown
    function updateCellSelect(selectElement) {
        const packingId = selectElement.dataset.id;
        const field = selectElement.dataset.field;
        const value = selectElement.value;

        // Store the original value in case we need to revert
        const originalValue = selectElement.dataset.originalValue || selectElement.value;

        // Store current value as original for future reverts
        selectElement.dataset.originalValue = originalValue;

        fetch('/packing/update_cell', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: packingId,
                field: field,
                value: value || null
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success feedback
                selectElement.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    selectElement.style.backgroundColor = '';
                }, 1000);

                // Update other calculated fields if they were returned
                if (data.updates) {
                    const row = selectElement.closest('tr');
                    for (const [key, val] of Object.entries(data.updates)) {
                        const cell = row.querySelector(`td[data-field="${key}"]`);
                        if (cell) {
                            cell.textContent = val;
                        }
                    }
                    
                    // Update totals if requirement_kg changed
                    if (data.updates.requirement_kg !== undefined || data.updates.requirement_unit !== undefined) {
                        updateTotals();
                    }
                }
            } else {
                console.error('Update failed:', data.error);
                alert('Error updating: ' + (data.error || 'Unknown error'));
                selectElement.value = originalValue;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating machinery: ' + error.message);
            selectElement.value = originalValue;
        });
    }
</script>
{% endblock %}