{% extends 'index.html' %}

{% block content %}
<div class="container mt-2">
    <div class="card">
        <div class="card-header">
            <h2 class="mb-0">
                <i class="fas fa-upload"></i> Upload Item Master Data
            </h2>
        </div>
        <div class="card-body">
            <div class="d-flex gap-2 mb-3">
                <a href="{{ url_for('item_master.item_master_list') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
                <a href="{{ url_for('item_master.item_master_create') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add New Item
                </a>
                <a href="{{ url_for('item_master.download_template') }}" class="btn btn-info">
                    <i class="fas fa-download"></i> Download Template
                </a>
                <a href="{{ url_for('item_master.download_excel') }}" class="btn btn-warning">
                    <i class="fas fa-file-excel"></i> Download Excel
                </a>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
            {% endwith %}

            <form method="post" enctype="multipart/form-data" id="uploadForm">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="file" class="form-label">Select Excel/CSV File</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".xlsx,.xls,.csv" required>
                            <div class="form-text">Supported formats: .xlsx, .xls, .csv</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="sheet_name" class="form-label">Sheet Name (Excel only)</label>
                            <input type="text" class="form-control" id="sheet_name" name="sheet_name" value="Item Master" placeholder="Leave blank for default sheet">
                            <div class="form-text">Default: "Item Master" (only used for Excel files)</div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5><i class="fas fa-table"></i> Required Columns</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Column Name</th>
                                        <th>Status</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Item Code</strong></td>
                                        <td><span class="badge bg-danger">Required</span></td>
                                        <td>Unique code for the item</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Description</strong></td>
                                        <td><span class="badge bg-danger">Required</span></td>
                                        <td>Item description</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Type</strong></td>
                                        <td><span class="badge bg-danger">Required</span></td>
                                        <td>Item type (must match existing types)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Category</strong></td>
                                        <td><span class="badge bg-info">Optional</span></td>
                                        <td>Category (optional, can be auto-populated)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Department</strong></td>
                                        <td><span class="badge bg-info">Optional</span></td>
                                        <td>Department (optional, can be auto-populated)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>UOM</strong></td>
                                        <td><span class="badge bg-danger">Required</span></td>
                                        <td>Unit of Measure (e.g., KG, L, PCS)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Min Level</strong></td>
                                        <td><span class="badge bg-info">Optional</span></td>
                                        <td>Minimum stock level</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Max Level</strong></td>
                                        <td><span class="badge bg-info">Optional</span></td>
                                        <td>Maximum stock level</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Price/KG</strong></td>
                                        <td><span class="badge bg-info">Optional</span></td>
                                        <td>Price per KG (if applicable)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Price/UOM</strong></td>
                                        <td><span class="badge bg-info">Optional</span></td>
                                        <td>Price per UOM (if applicable)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Status</strong></td>
                                        <td><span class="badge bg-info">Optional</span></td>
                                        <td>Active/Inactive (default: Active)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-success mt-3" role="alert">
                            <h6><i class="fas fa-magic"></i> Auto-calculated/Optional Fields:</h6>
                            <p class="mb-0">Fields like Category, Department, Min/Max Level, and pricing can be auto-populated or left blank if not applicable.<br>
                            Ensure Item Code and Description are unique and required.</p>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="alert alert-info" role="alert">
                            <h6><i class="fas fa-info-circle"></i> Important Notes:</h6>
                            <ul class="mb-0">
                                <li>Item Code and Description are required and must be unique</li>
                                <li>Type and UOM are required and must match existing values</li>
                                <li>Other fields can be left blank or will be auto-populated if not provided</li>
                                <li>Download the template above for the correct format</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 justify-content-between">
                    <div>
                        <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                            <i class="fas fa-upload"></i> Upload Item Master Data
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </form>

            <!-- Progress bar (hidden by default) -->
            <div id="progressContainer" class="mt-3" style="display: none;">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
                        Processing file...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sample data preview -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-eye"></i> Sample Data Format</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Item Code</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Department</th>
                            <th>UOM</th>
                            <th>Min Level</th>
                            <th>Max Level</th>
                            <th>Price/KG</th>
                            <th>Price/UOM</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>RM0001</td>
                            <td>Salt</td>
                            <td>Raw Material</td>
                            <td>Spices</td>
                            <td>Production</td>
                            <td>KG</td>
                            <td>10</td>
                            <td>100</td>
                            <td>1.50</td>
                            <td>1.50</td>
                            <td>Active</td>
                        </tr>
                        <tr>
                            <td>PK0002</td>
                            <td>Plastic Bag</td>
                            <td>Packing</td>
                            <td>Packing Material</td>
                            <td>Packing</td>
                            <td>PCS</td>
                            <td>100</td>
                            <td>1000</td>
                            <td></td>
                            <td>0.05</td>
                            <td>Active</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="alert alert-warning mt-3" role="alert">
                <h6><i class="fas fa-info-circle"></i> Template Notes:</h6>
                <ul class="mb-0">
                    <li><strong>Item Code, Description, Type, UOM</strong> are required</li>
                    <li>Other columns are optional and can be left blank</li>
                    <li>Type and UOM must match existing values in the system</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    border: none;
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
    padding: 1rem 1.35rem;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #000000;
}

.form-control, .form-select {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    border: 1px solid #d1d3e2;
    border-radius: 0.35rem;
}

.form-control:focus, .form-select:focus {
    border-color: #bac8f3;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    border-radius: 0.35rem;
}

.btn-primary {
    background-color: #4e73df;
    border-color: #4e73df;
}

.btn-secondary {
    background-color: #858796;
    border-color: #858796;
}

.btn-success {
    background-color: #1cc88a;
    border-color: #1cc88a;
}

.btn-info {
    background-color: #36b9cc;
    border-color: #36b9cc;
}

.btn-warning {
    background-color: #f6c23e;
    border-color: #f6c23e;
}

.progress {
    height: 1rem;
    background-color: #f8f9fc;
}

.progress-bar {
    background-color: #4e73df;
}

.table {
    font-size: 0.875rem;
}

.table thead th {
    background-color: #f8f9fc;
    border-bottom: 2px solid #e3e6f0;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #000000;
}

.table-hover tbody tr:hover {
    background-color: rgba(78, 115, 223, 0.05);
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.btn-lg {
    padding: 0.5rem 1rem;
    font-size: 1.125rem;
}

.alert-info {
    background-color: #e7f3ff;
    border-color: #b8daff;
    color: #004085;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-text {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.badge {
    font-size: 0.75rem;
}
</style>

<script>
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    var fileInput = document.getElementById('file');
    var uploadBtn = document.getElementById('uploadBtn');
    var progressContainer = document.getElementById('progressContainer');
    
    if (!fileInput.files[0]) {
        e.preventDefault();
        alert('Please select a file to upload.');
        return;
    }
    
    // Show progress bar and disable button
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    progressContainer.style.display = 'block';
});

document.getElementById('file').addEventListener('change', function(e) {
    var file = e.target.files[0];
    if (file) {
        var fileSize = (file.size / 1024 / 1024).toFixed(2); // Convert to MB
        var fileType = file.name.split('.').pop().toLowerCase();
        
        // Add file info below the input
        var existingInfo = document.getElementById('fileInfo');
        if (existingInfo) {
            existingInfo.remove();
        }
        
        var fileInfo = document.createElement('div');
        fileInfo.id = 'fileInfo';
        fileInfo.className = 'mt-2 text-muted';
        fileInfo.innerHTML = `
            <small>
                <i class="fas fa-file"></i> ${file.name} (${fileSize} MB)
                <span class="badge bg-${fileType === 'csv' ? 'success' : 'primary'}">${fileType.toUpperCase()}</span>
            </small>
        `;
        
        e.target.parentNode.appendChild(fileInfo);
    }
});
</script>
{% endblock %} 